/*                Банковская интегрированная система БИСквит    Copyright:  (C) 1992-1997 ТОО "Банковские информационные системы"     Filename:  OP-ENBUM.I2      Comment:  Бухгалтерский журнал разбивка по отделениям и сотрудникам для ВТБ         Uses:      Used by:  op-enbum.p      Created: 18/09/02 Gorm     Modified: 16/08/2004 kraw (0026160) Если only-branch, то не печатаются документы под референсом отдела автоматизации     Modified: 25/11/2004 kraw (0039253) Устранение дублирования печати названия филиала     Modified: 16/03/2005 kraw (0044111) Проверка расположения отдела автоматизации в иерархии*/                                               AND         ((vOpRubLog AND xentry.currency = "") OR       /* рублевые */          (vOpCurLog AND xentry.currency <> ""))        /* валютные */   NO-LOCK&IF DEFINED(UserAndSlave) NE 0 &THEN           ,   FIRST tt-usr WHERE tt-usr.acctc EQ xentry.acct-cat                  AND tt-usr.br-id EQ xentry.branch                  AND tt-usr.us-id EQ xentry.user-id   NO-LOCK&ENDIF   BREAK BY xentry.branch_p         BY xentry.branch         BY xentry.prnum&IF DEFINED(UserAndSlave) NE 0 &THEN         BY tt-usr.bo-id&ENDIF         BY xentry.user-id/*	 BY xentry.is_earch*/	 BY xentry.currency         BY SUBSTRING(xentry.acct-db,1,8) + SUBSTRING(xentry.acct-db,10)         BY SUBSTRING(xentry.acct-cr,1,8) + SUBSTRING(xentry.acct-cr,10)         BY SUBSTRING("000000" + xentry.doc-num,LENGTH(xentry.doc-num) + 1)	    WITH FRAME fentry: /* Выделяем сумму по переоценке */   IF FIRST-OF(xentry.prnum) THEN DO:				ASSIGN				         dItogPRur = 0				 dItogPVal = 0				 dItogPC   = 0				.			         END.   IF xentry.prnum = 3 THEN DO:			ASSIGN		         dItogPRur = dItogPRur + xentry.amt			 dItogPVal = dItogPVal + xentry.vamt			 dItogPC   = dItogPC + 1			.		     END.					   IF FIRST(xentry.branch) THEN DOWN 1.   /* печать наименования подразделения */   IF FIRST-OF(xentry.branch_p)      AND only-branch <> YES      AND xentry.prnum <> 3 THEN DO:         FIND FIRST branch WHERE branch.branch-id = xentry.branch_p NO-LOCK NO-ERROR./*         IF AVAILABLE branch THEN            PUT UNFORMATTED xentry.branch_p " " TRIM(branch.name) SKIP(1).*/&IF DEFINED(UserAndSlave) NE 0 &THEN/* определим список начальников по разделу отчета для данного отдела */   mUserBran = "".   IF     mUserACat NE ""       AND xentry.branch NE "" THEN   DO:      mI = LOOKUP(xentry.branch,mUserACat,";") + 1.      IF mI GT 1 THEN         mUserBran = ENTRY(mI,mUserACat,";").   END.&ENDIF   END.   IF     (NOT FIRST-OF(xentry.branch_p)      OR  only-branch       OR  xentry.prnum EQ 3      OR  xentry.branch_p NE xentry.branch)      AND FIRST-OF(xentry.branch) THEN DO:      FIND FIRST branch WHERE branch.branch-id = xentry.branch         NO-LOCK NO-ERROR.      IF AVAILABLE branch THEN         PUT UNFORMATTED SKIP(1) xentry.branch " " TRIM(cBankName) SKIP(1).   END.   mAsuPar = "".   RUN GetBranchChild(xentry.branch,INPUT-OUTPUT mAsuPar).   IF xentry.refer NE "" AND xentry.refer EQ n_asu AND NOT CAN-DO(mAsuPar, xentry.refer) THEN      NEXT.   mAcctDb = xentry.acct-db.   FIND FIRST acct WHERE acct.acct     EQ xentry.acct-db                     /*AND acct.currency EQ xentry.currency*/      NO-LOCK NO-ERROR.   IF AVAILABLE acct THEN /* не конфеденциальный ли номер счета? */      IF GetXAttrValueEx("acct",                         acct.acct + "," + acct.currency,                         "confiden",                         "Нет") EQ "Да" THEN      DO:         mMask = GetXAttrInit(acct.class-code, "acct").         mAcctDb = "".         DO mItem = 1 TO LENGTH(mMask):            IF    SUBSTRING(mMask, mItem, 1) EQ "б"               OR SUBSTRING(mMask, mItem, 1) EQ "в" THEN               mAcctDb = mAcctDb + SUBSTRING(acct.acct, mItem, 1).            ELSE               mAcctDb = mAcctDb + "X".         END.      END.   mAcctCr = xentry.acct-cr.   FIND FIRST acct WHERE acct.acct     EQ xentry.acct-cr                     AND acct.currency EQ xentry.currency      NO-LOCK NO-ERROR.   IF AVAILABLE acct THEN /* не конфеденциальный ли номер счета? */      IF GetXAttrValueEx("acct",                         xentry.acct-cr + "," + xentry.currency,                         "confiden",                         "Нет") EQ "Да" THEN      DO:         mMask = GetXAttrInit(acct.class-code, "acct").         mAcctCr = "".         DO mItem = 1 TO LENGTH(mMask):            IF    SUBSTRING(mMask, mItem, 1) EQ "б"               OR SUBSTRING(mMask, mItem, 1) EQ "в" THEN               mAcctCr = mAcctCr + SUBSTRING(acct.acct, mItem, 1).            ELSE               mAcctCr = mAcctCr + "X".         END.      END.&IF DEFINED(UserAndSlave) NE 0 &THEN   IF FIRST-OF(tt-usr.bo-id) THEN   DO:      ASSIGN         p-bo-amt = 0         p-bo-num = 0      ./* проверим, есть ли у него подчиненные и отражена ли их работа в этом разделе*/      IF     mUserBran NE ""         AND LOOKUP(tt-usr.bo-id, mUserBran) GT 0         AND tt-usr.bo-id NE "" THEN         PUT UNFORMATTED SKIP            "Ответственный исполнитель " + tt-usr.bo-id SKIP(1).   END.&ENDIF/* ТАК НЕ НАДО/*** ПОМЕЧАЕМ ДОКУМЕНТЫ ИЗ АРХИВА ***/IF FIRST-OF(xentry.is_earch) THEN DO:IF xentry.is_earch THEN PUT UNFORMATTED "*** В ЭЛЕКТРОННОМ АРХИВЕ ***" SKIP.		   ELSE PUT UNFORMATTED "*** НА БУМАГЕ ***" SKIP.END.*/   DISPLAY        xentry.doc-num AT 2        mAcctDb @ xentry.acct-db        mAcctCr @ xentry.acct-cr        xentry.vamt WHEN xentry.vamt <> 0 FORMAT "->,>>>,>>>,>>9.99"        xentry.amt FORMAT "->,>>>,>>>,>>9.99"        xentry.user-name FORMAT "x(25)"        xentry.refer FORMAT "x(11)".   DOWN 1.   IF FIRST-OF(xentry.currency) THEN DO:     r-amt = 0.     r-num = 0.     v-amt = 0.     v-num = 0.   END.    ASSIGN     {1}-amt = {1}-amt + xentry.amt     {1}-num = {1}-num + 1     p-amt = p-amt + xentry.amt     p-num = p-num + 1     r-amt = r-amt + xentry.amt     r-num = r-num + 1     v-amt = v-amt + xentry.vamt     v-num = v-num + 1     b-amt = b-amt + xentry.amt     b-num = b-num + 1     pr-amt = pr-amt + xentry.amt     pr-num = pr-num + 1.&IF DEFINED(UserAndSlave) NE 0 &THEN   ASSIGN      p-bo-amt = p-bo-amt + 1      p-bo-num = p-bo-num + 1   .&ENDIF   IF LAST-OF(xentry.currency) AND xentry.prnum = 2 THEN DO:      IF xentry.currency NE "" THEN DO:	         cur_btxt = "Итого по валюте " + xentry.currency + cur_txt +                    xentry.user-id.        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12=v-amt &c13=r-amt &c21="'Кол-во проводок:'" &c22="''" &c23=v-num}/*         PUT UNFORMATTED SKIP(1)             cur_btxt FORMAT "x(80)"             " " v-amt FORMAT "->,>>>,>>>,>>9.99"               " " r-amt FORMAT "->,>>>,>>>,>>9.99" SKIP              "Кол-во проводок: "             v-num FORMAT ">>>,>>9" SKIP(1).*/      END.      ELSE DO:         cur_btxt = "Итого по рублям " + cur_txt +                    xentry.user-id.        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12="''" &c13=r-amt &c21="'Кол-во проводок:'" &c22="''" &c23=v-num}/*         PUT UNFORMATTED SKIP(1)             cur_btxt FORMAT "x(80)"             " " r-amt FORMAT "->,>>>,>>>,>>9.99" SKIP              "Кол-во проводок: "             v-num FORMAT ">>>,>>9" SKIP(1).*/      END.      ASSIGN        v-num = 0        v-amt = 0        r-num = 0        r-amt = 0.   END.   IF LAST-OF(xentry.user-id) AND xentry.prnum = 2 THEN DO:      cur_btxt = "Итого по исполнителю " + cur_txt +                 xentry.user-id.	{pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12="''" &c13=p-amt &c21="'Кол-во проводок:'" &c22="''" &c23=p-num}/*      PUT UNFORMATTED SKIP(1)        cur_btxt FORMAT "x(80)"        " " p-amt FORMAT "->,>>>,>>>,>>9.99"  SKIP        "Кол-во проводок: "        p-num FORMAT ">>>,>>9" SKIP(1).*/      ASSIGN        p-num = 0        p-amt = 0.   END.   IF LAST-OF(xentry.user-id) AND xentry.prnum = 1 THEN DO:      cur_btxt = "Итого по исполнителю " + cur_txt +                 xentry.refer.        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12="''" &c13=p-amt &c21="'Кол-во проводок:'" &c22="''" &c23=p-num}/*      PUT UNFORMATTED SKIP(1)        cur_btxt FORMAT "x(80)"        " " p-amt FORMAT "->,>>>,>>>,>>9.99"  SKIP        "Кол-во проводок: "        p-num FORMAT ">>>,>>9" SKIP(1).*/      ASSIGN        p-num = 0        p-amt = 0.   END./*   IF LAST-OF(xentry.prnum) AND xentry.prnum = 1 THEN DO:      cur_btxt = "Итого по исполнителю " + cur_txt +                 xentry.refer.      PUT UNFORMATTED SKIP(1)        cur_btxt FORMAT "x(80)"        " " p-amt FORMAT "->,>>>,>>>,>>9.99" SKIP        "Кол-во проводок: "        p-num FORMAT ">>>,>>9" SKIP(1).      ASSIGN        p-num = 0        p-amt = 0.   END.*/ &IF DEFINED(UserAndSlave) NE 0 &THEN   IF     LAST-OF(tt-usr.bo-id)      AND tt-usr.bo-id NE ""      AND LOOKUP(tt-usr.bo-id, mUserBran) GT 0 THEN   DO:      cur_btxt = "Итого по отв. исполнителю " + cur_txt +                 tt-usr.bo-id.        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12="''" &c13=p-bo-amt &c21="'Кол-во проводок:'" &c22="''" &c23=p-bo-num}    /*      PUT UNFORMATTED SKIP(1)        cur_btxt FORMAT "x(80)"        " " p-bo-amt FORMAT "->,>>>,>>>,>>9.99" SKIP        "Кол-во проводок: "        p-bo-num FORMAT ">>>,>>9" SKIP(1).*/   END.&ENDIF   IF LAST-OF(xentry.branch) THEN DO:        /*** Итого по переоценке ***/	IF dItogPC > 0 THEN	DO:		PUT UNFORMATTED SKIP(1).	        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11="'Итого по переоценке:'" &c12=dItogPVal &c13=dItogPRur &c21="'Кол-во проводок:'" &c22="''" &c23=dItogPC}	END.      IF xentry.prnum = 3 THEN DO:         PUT UNFORMATTED " " SKIP.         cur_btxt = "Итого по ".      END.      ELSE cur_btxt = "Итого по отделу ".      cur_btxt = cur_btxt + xentry.branch + cur_txt.      ASSIGN          dSumByC   = dSumByC + b-amt          dCountByC = dCountByC + b-num       .        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12="''" &c13=b-amt &c21="'Кол-во проводок:'" &c22="''" &c23=b-num}/*      PUT UNFORMATTED         cur_btxt FORMAT "x(80)"         " " b-amt FORMAT "->,>>>,>>>,>>9.99" SKIP         "Кол-во проводок: "         b-num FORMAT ">>>,>>9" SKIP.*/      ASSIGN        b-num = 0        b-amt = 0        p-num = 0        p-amt = 0.   END.   IF LAST-OF(xentry.branch_p) AND only-branch <> YES THEN DO:      IF xentry.prnum <> 3 THEN DO:         cur_btxt = "Итого по подразделению " + xentry.branch_p + cur_txt.        {pir-cr2x2t.i &w1=65 &w2=15 &w3=15 &c11=cur_btxt &c12="''" &c13=pr-amt &c21="'Кол-во проводок:'" &c22="''" &c23=pr-num}/*         PUT UNFORMATTED SKIP(1)            cur_btxt FORMAT "x(80)"            " " pr-amt FORMAT "->,>>>,>>>,>>9.99" SKIP            "Кол-во проводок: "            pr-num FORMAT ">>>,>>9" SKIP(2).*/      END.      ASSIGN        pr-num = 0        pr-amt = 0.   END.