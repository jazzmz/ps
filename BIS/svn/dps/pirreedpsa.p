{pirsavelog.p}


/*
               Банковская интегрированная система БИСквит
    Copyright: (C) 1992-2004 ТОО "Банковские информационные системы"
     Filename: pirreedpsa.p
      Comment: Печать реестра обязательств банка перд вкладчиками
   Parameters:
         Uses:
      Used by:
      Created: 18.08.2004 15:36 FEAK    
     Modified: 19.08.2004 15:00 FEAK     
     Modified: 11.03.2005 12:58 SAP      
     Modified: 14.03.2005 09:33 SAP      
     Modified: 
*/

DEFINE INPUT PARAMETER in-data-id LIKE DataBlock.Data-Id NO-UNDO.

{globals.i}
{wordwrap.def}
{norm.i}
{repinfo.i}
{intrface.get xclass}
{intrface.get strng}
{intrface.get cdrep}
{bank-id.i}

{get-bankname.i}

&glob STREAM STREAM mStr
&glob COLS 306

DEF VAR vMaxLines AS INTEGER NO-UNDO. 
DEF VAR mString AS CHAR EXTENT 12 NO-UNDO. 
DEF VAR mLength AS INT EXTENT 12 NO-UNDO. 
DEF VAR mS AS CHAR EXTENT 11 NO-UNDO.
DEF VAR i AS INTEGER NO-UNDO.
DEF VAR mI AS INTEGER NO-UNDO.
DEF VAR j AS INTEGER NO-UNDO.
DEF VAR vSString AS CHAR NO-UNDO.
DEF VAR vAFlag AS LOGICAL NO-UNDO.
DEF VAR vBFlag AS LOGICAL NO-UNDO.
DEF VAR vChet AS LOGICAL NO-UNDO.
DEF VAR vCurSysNum AS CHAR NO-UNDO.
DEF VAR vRec1 AS RECID NO-UNDO.
DEF VAR vRec2 AS RECID NO-UNDO.
DEF VAR vMaxVzSum AS DEC FORMAT "->>>,>>>,>>9.99" NO-UNDO.
DEF VAR vDate AS DATE FORMAT "99/99/9999" NO-UNDO.
DEF VAR in-end-date AS DATE FORMAT "99/99/9999" NO-UNDO.
DEF VAR vBank AS CHAR NO-UNDO.
DEF VAR vAdress AS CHAR NO-UNDO.
DEF VAR vKolKl AS CHAR NO-UNDO.

DEF VAR vSumRubD AS dec NO-UNDO.
DEF VAR vSumCurrD AS dec NO-UNDO.
DEF VAR vSumRubC AS dec NO-UNDO.
DEF VAR vSumCurrC AS dec NO-UNDO.
DEF VAR vSumRubCC AS dec NO-UNDO.
DEF VAR vSumCurrCC AS dec NO-UNDO.

DEF VAR vSum17 AS dec NO-UNDO.
DEF VAR vSum18 AS dec NO-UNDO.
DEF {&STREAM}.

{fexp-chk.i
   &DataID = " in-Data-Id"}

FIND FIRST DataBlock WHERE DataBlock.Data-Id EQ in-Data-Id NO-LOCK.
IF AVAIL DataBlock THEN
   ASSIGN vDate = DataBlock.End-Date.

/*vBank  = "Коммерческий банк промышленно-инвестиционных расчетов " + chr(34) + "Пpоминвестрасчет" + chr(34) + "(общество с ограниченной ответственностью)".*/
vBank = cBankNameFull.
vAdress  = FGetSetting( "Адрес_пч", "", "" ).


DO
ON ERROR UNDO, LEAVE
ON ENDKEY UNDO, LEAVE
WITH FRAME fr1
   CENTERED
   ROW 10
   OVERLAY
   SIDE-LABELS
   1 COL
   COLOR MESSAGES
   TITLE "[ МАКСИМАЛЬНАЯ СУММА ВОЗМЕЩЕНИЯ ]":

vMaxVzSum = 700000.
   DISPLAY vMaxVzSum.

   UPDATE
      vMaxVzSum
         LABEL "Сумма возмещения:"
         HELP  "Задайте максимальную сумму возмещения."

    EDITING:
        READKEY.
        APPLY LASTKEY.
    END.   
END.

HIDE FRAME fr1 NO-PAUSE.

IF KEYFUNC(LASTKEY) EQ "end-error"
THEN RETURN.

 &IF DEFINED(REEDPSA_SAV) &THEN
  in-end-date= DataBlock.End-Date.
  {pirraproc.def}
  {pirraproc.i &arch_file_name="ree_vkl.txt"}
  {setdest.i  &filename=arch_file_name}
 &ELSE
  {setdest.i '&stream={&STREAM}' &filename="reestr.txt"}
 &ENDIF

/*получение данных из блока данных - ?*/
{pirree_dps.i}

ASSIGN 
   mString[1] = ""
   mString[2] = "" 
   mString[3] = ""
   mString[4] = "" 
   mString[5] = ""
   mString[6] = ""
   mLength[1] = 6
   mLength[2] = 18
   mLength[3] = 20
   mLength[4] = 25
   mLength[5] = 16
   mLength[6] = 16
   
      .

ASSIGN 
   vMaxLines = 1
   j = 1
   i = 1
   .
   
/*Вывод реквизитов банка*/

PUT {&STREAM} UNFORMATTED 
   SKIP(1)
   fStrCenter ("Реестр обязательств банка перед вкладчиками, представляемый на бумажном носителе", {&COLS}) SKIP 
   fStrCenter ("по состоянию на " + STRING (vDate + 1), {&COLS}) SKIP(1).

PUT {&STREAM} UNFORMATTED
   "Сведения о банке" SKIP
   "Наименование банка:  " vBank SKIP
   "Почтовый адрес:  " vAdress SKIP
   "Регистрационный номер:  " bank-regn SKIP(1).

/*Вывод шапки*/

PUT {&STREAM} UNFORMATTED
   "┌──────┬──────────────────┬────────────────────┬─────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────┬────────────────┐" SKIP
   "│Номер │      Ф.И.О.      │       Адрес        │        Код вида и       │                                            Обязательства банка                                   │                                               Встречные требования                               │     Сумма      │     Сумма,     │" SKIP
   "│вклад-│                  │     регистра-      │         реквизиты       ├────────────────────┬──────────┬───────────┬────────────────────┬────────────────┬────────────────┼────────────────────┬──────────┬───────────┬────────────────────┬────────────────┬────────────────┤  обязательств  │   подлежащая   │" SKIP     
   "│ чика │                  │      ции, для      │        документа,       │       Номер        │   Дата   │ Порядковый│       Номер        │     Сумма      │     Сумма      │       Номер        │   Дата   │ Порядковый│       Номер        │     Сумма      │     Сумма      │       по       │   страховому   │" SKIP
   "│  по  │                  │      почтовых      │        удостоверя-      │     документа      │документа,│   номер   │      лицевого      │       в        │       в        │     документа,     │документа,│   номер   │      лицевого      │       в        │       по       │     вкладам    │   возмещению   │" SKIP
   "│реест-│                  │     уведомле-      │           ющего         │        на          │    на    │ филиала,  │       счета        │     валюте     │     рублях     │         на         │    на    │  филиала, │       счета        │     валюте     │   встречным    │       за       │                │" SKIP
   "│  ру  │                  │        ний,        │         личность        │     основании      │основании │ заключив- │        для         │  обязательств  │       по       │     основании      │ основании│ заключив- │        для         │   требования   │  требованиям   │     вычетом    │                │" SKIP
   "│обяза-│                  │      телефон,      │                         │      которого      │ которого │    шего   │       учета        │                │     курсу      │      которого      │ которого │   шего    │       учета        │                │       в        │      суммы     │                │" SKIP
   "│тельст│                  │     электрон-      │                         │       принят       │  принят  │  договор  │    обязательств    │                │     Банка      │      возникло      │ возникло │  договор  │     встречных      │                │     рублях     │    встречных   │                │" SKIP
   "│  в   │                  │     ная почта      │                         │       вклад        │   вклад  │           │                    │                │     России     │     требование     │требование│           │    требований      │                │       по       │   требований   │                │" SKIP
   "│      │                  │                    │                         │                    │          │           │                    │                │                │                    │          │           │                    │                │     курсу      │                │                │" SKIP
   "│      │                  │                    │                         │                    │          │           │                    │                │                │                    │          │           │                    │                │     Банка      │                │                │" SKIP
   "│      │                  │                    │                         │                    │          │           │                    │                │                │                    │          │           │                    │                │     России     │                │                │" SKIP
   "├──────┼──────────────────┼────────────────────┼─────────────────────────┼────────────────────┼──────────┼───────────┼────────────────────┼────────────────┼────────────────┼────────────────────┼──────────┼───────────┼────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤" SKIP
   "│  1   │        2         │         3          │           4             │         5          │    6     │     7     │          8         │       9        │       10       │         11         │    12    │    13     │         14         │       15       │       16       │       17       │       18       │" SKIP.

   
FOR EACH ttRee BY ttRee.id:

   ASSIGN
      i = 0
      j = 1
      vMaxLines = 0
      mString[5] = "0"
      mString[6] = "0"
      mString[1] = /* STRING(ttRee.id)  string(INT(ttRee.SysNum),">>>>>9")*/ string(ttRee.SysNum)
      mString[2] = ttRee.FIO
      mString[3] = ttRee.AdressReq + ", " + ttRee.AdressPos + ", " + ttRee.Phone + ", " + ttRee.Email
      mString[4] = ttRee.DocTypeCode + ", " + ttRee.DocNum + ", " + ttRee.KemVidano
      vKolKl = STRING(ttRee.id)
      .
  

     vSumRubC = 0.
     vSumCurrC = 0.  
   FOR EACH ttReeLoan WHERE ttReeLoan.SysNum EQ ttRee.SysNum:
      IF ttReeLoan.Symbol = "д" THEN
         ASSIGN 
            mString[5] = STRING(DEC(mString[5]) + ttReeLoan.SumInRur,"->>>,>>>,>>9.99")
	    .
      ELSE IF ttReeLoan.Symbol = "к" THEN
         ASSIGN 
            mString[5] = STRING(DEC(mString[5]) - ttReeLoan.SumInRur,"->>>,>>>,>>9.99")
            . 
   END.

   IF DEC(mString[5]) LT 0 THEN
      ASSIGN mString[5] = STRING(0).
  
 /*Старый вариант
   IF DEC(mString[5]) LE 100000.00 THEN
      ASSIGN mString[6] = mString[5].
   IF DEC(mString[5]) GT 100000.00 and  DEC(mString[5]) LE vMaxVzSum THEN
      mString[6] = STRING(100000.00 + ((dec(mString[5]) - 100000.00) / 100 * 90),"->>>,>>>,>>9.99").
*/

/*Ермилов В.Н.: Новый вариант в соответствии с изменениями  N 174-ФЗ от 13 октября 2008  */
   IF DEC(mString[5]) LE vMaxVzSum THEN
      ASSIGN mString[6] = mString[5].

   IF DEC(mString[5]) GT vMaxVzSum THEN
      ASSIGN mString[6] = STRING(vMaxVzSum,"->>>,>>>,>>9.99").
      
  vSum17 = dec(mString[5]) + vSum17.
  vSum18 = dec(mString[6]) + vSum18.

   /*расчет кол-ва символов под запись*/
   DO i = 1 TO 10:
      ASSIGN mS[1] = mString[i]
      {wordwrap.i &s = mS
                  &n = 10
                  &l = mLength[i]}
      DO WHILE mS[j] NE "":
         ASSIGN j = j + 1.
      END.
      IF j GT vMaxLines THEN
         ASSIGN vMaxLines = j - 1.
   END.
   ASSIGN j = 0.
   FOR EACH ttReeLoan WHERE ttReeLoan.SysNum EQ ttRee.SysNum
                        AND ttReeLoan.Symbol EQ "к":
      ASSIGN j = j + 2.
   END.
   IF j GT vMaxLines THEN
         ASSIGN vMaxLines = j - 1.
   ASSIGN j = 0.
   FOR EACH ttReeLoan WHERE ttReeLoan.SysNum EQ ttRee.SysNum
                        AND ttReeLoan.Symbol EQ "д":
      ASSIGN j = j + 2.
   END.
   IF j GT vMaxLines THEN
         ASSIGN vMaxLines = j - 1.

   PUT {&STREAM} UNFORMATTED
      "├──────┼──────────────────┼────────────────────┼─────────────────────────┼────────────────────┼──────────┼───────────┼────────────────────┼────────────────┼────────────────┼────────────────────┼──────────┼───────────┼────────────────────┼────────────────┼────────────────┼────────────────┼────────────────┤" SKIP.

   DO j = 1 TO vMaxLines: /*цикл по строкам*/
      DO i = 1 TO 4:      /*цикл по элементам... 1-2-3...*/
         ASSIGN mS[1] = mString[i]. /*сохраняем для будущей порезки*/
         {wordwrap.i &s = mS
                     &n = 2
                     &l = mLength[i]
         }
         ASSIGN mString[i] = mS[2]. /*отрезали, теперь все что не понадобилось сохраняем 
                                      для будущего шага по строкам*/
         RUN Cutter (mLength[i], 1, NO).

         /*добавили пробелов до нужного количества*/
         PUT {&STREAM} UNFORMATTED "│" mS[1]. /*вывели саму строчку*/
      END.

      /*теперь будем выводить кредиты и депозиты*/
         ASSIGN VAFlag = NO.
         IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN
            FIND FIRST ttReeLoan WHERE ttReeLoan.SysNum EQ ttRee.SysNum
                                  AND ttReeLoan.Symbol EQ "д" NO-ERROR.
         ELSE 
            FIND LAST ttReeLoan WHERE RECID(ttReeLoan) EQ vRec1 NO-ERROR.
         IF AVAIL ttReeLoan THEN
         DO:
            ASSIGN
               vRec1 = RECID(ttReeLoan)
               VAFlag = YES
               ttReeLoan.Symbol = "й"
               .

            ASSIGN
               mString[7] = ttReeLoan.ContNum
               mLength[7] = 20
               mString[8] = ttReeLoan.ContDate
               mLength[8] = 10
               mString[9] = ttReeLoan.BankRegNum
               mLength[9] = 11
               mString[10] = ttReeLoan.AcctNum
               mLength[10] = 20
               mString[11] = STRING(ttReeLoan.SumInCurr,"->>>,>>>,>>9.99")
               mLength[11] = 16
               mString[12] = STRING(ttReeLoan.SumInRur,"->>>,>>>,>>9.99")
               mLength[12] = 16
               .
       
            DO i = 1 TO 6:
               ASSIGN mS[1] = mString [(i + 6)].
               RUN Cutter (mLength[(i + 6)], 1, YES).
               ASSIGN mString [(i + 6)] = mS[1].
            END.

            IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN
	      do:
            /*выводим по шагам инфу по вкладу*/
               ASSIGN 
                  vSString = "│" + mString[7] + 
                             "│" + mString[8] +
                             "│" + mString[9] +
                             "│" + mString[10] + 
                             "│" + mString[11] + 
                             "│" + mString[12] + ""
                  vChet = NO.
		  vSumCurrD = dec(mString[11]) + vSumCurrD.
		  vSumRubD = dec(mString[12]) + vSumRubD.
	      end.	  
            ELSE IF (((j / 2) - TRUNCATE (j / 2, 0)) EQ 0) AND j NE vMaxLines THEN
               ASSIGN 
                  vSString = "├────────────────────┼──────────┼───────────┼────────────────────┼────────────────┼────────────────"
                  vChet = YES
                  vAFlag = YES
                  .
            ELSE
               ASSIGN 
                  vSString = "│                    │          │           │                    │                │                "
                  vChet = YES
                  vAFlag = NO.
         END.
         ELSE
         DO:
            ASSIGN
               vRec1 = 000000
               VAFlag = NO
               .
            PUT {&STREAM} UNFORMATTED
               "│                    │          │           │                    │                │                ".
         END.

         IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN
            FIND FIRST ttReeLoan WHERE ttReeLoan.SysNum EQ ttRee.SysNum
                                  AND ttReeLoan.Symbol EQ "к" NO-ERROR.
         ELSE 
            FIND LAST ttReeLoan WHERE RECID(ttReeLoan) EQ vRec2 NO-ERROR.
         IF AVAIL ttReeLoan THEN
         DO:
            ASSIGN 
               vRec2 = RECID(ttReeLoan)
               ttReeLoan.Symbol = "ц"
               vBFlag = YES
               .
            ASSIGN
               mString[7] = ttReeLoan.ContNum
               mLength[7] = 20
               mString[8] = ttReeLoan.ContDate
               mLength[8] = 10
               mString[9] = ttReeLoan.BankRegNum
               mLength[9] = 11
               mString[10] = ttReeLoan.AcctNum
               mLength[10] = 20
               mString[11] = STRING(ttReeLoan.SumInCurr,"->>>,>>>,>>9.99")
               mLength[11] = 16
               mString[12] = STRING(ttReeLoan.SumInRur,"->>>,>>>,>>9.99")
               mLength[12] = 16
	       .
	       
/* 	       if dec(mString[11]) NE 0 then 
	       vSumCurrC = dec(mString[11]) + vSumCurrC.
	        else vSumCurrC = vSumCurrD.
               if dec(mString[12]) NE 0 then
	       vSumRubC = dec(mString[12]) + vSumRubC.
	        else vSumRubC = vSumRubC.
*/             
            DO i = 1 TO 6:
               ASSIGN mS[1] = mString [(i + 6)].
               RUN Cutter (mLength[(i + 6)], 1, YES).
               ASSIGN mString [(i + 6)] = mS[1].
            END.
            IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN
            DO:
               ASSIGN 
                  vSString = vSString + "│" + mString[7] + 
                             "│" + mString[8] +
                             "│" + mString[9] +
                             "│" + mString[10] + 
                             "│" + mString[11] + 
                             "│" + mString[12] + ""
                  .
		
 	       if dec(mString[11]) NE 0 then 
	       vSumCurrC = dec(mString[11]) + vSumCurrC.
	    else vSumCurrC = vSumCurrC.
               if dec(mString[12]) NE 0 then
	       vSumRubC = dec(mString[12]) + vSumRubC.
	        else vSumRubC = vSumRubC.

	    END.
            ELSE
            DO:
               IF vAFlag = YES THEN
                  ASSIGN vSString = vSString + "┼".
               ELSE IF (j NE vMaxLines) AND (vAFlag = YES) THEN
                  ASSIGN vSString = vSString + "├".
               ELSE IF vAFlag = NO AND j NE vMaxLines THEN
                  ASSIGN vSString = vSString + "├".
               ELSE IF (j EQ vMaxLines) THEN
                  ASSIGN vSString = vSString + "│".
               ELSE
                  ASSIGN vSString = vSString + "│".
               IF j NE vMaxLines THEN
                  ASSIGN vSString = vSString + "────────────────────┼──────────┼───────────┼────────────────────┼────────────────┼────────────────".
 
		  
               ELSE
                  ASSIGN 
                     vSString = vSString + "                    │          │           │                    │                │                "
                     vBFlag = NO.
            END.
         END.
         ELSE
         DO:
            ASSIGN 
               vRec2 = 000000
               vBFlag = NO
               .
            IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN
               ASSIGN vSString = vSString + "│                    │          │           │                    │                │                ".
            ELSE
            DO:
               IF vAFlag = YES THEN
                  ASSIGN vSString = vSString + "┤".
               ELSE
                  ASSIGN vSString = vSString + "│".
               ASSIGN vSString = vSString + "                    │          │           │                    │                │                ".
            END.
         END.

      PUT {&STREAM} UNFORMATTED vSString.

      IF j = vMaxLines THEN
      DO:
         IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN 
            ASSIGN vSString = "│".
         ELSE 
            IF vBFlag = YES THEN
               ASSIGN vSString = "┤".
            ELSE 
               ASSIGN vSString = "│".      
         ASSIGN mS[1] = mString[5].
         RUN Cutter (mLength[5], 1, YES).    
         ASSIGN vSString = vSString + mS[1] + "│".
         ASSIGN mS[1] = mString[6].
         RUN Cutter (mLength[6], 1, YES). 
         ASSIGN vSString = vSString + mS[1] + "│".
      END.
      ELSE
      DO:
         IF ((j / 2) - TRUNCATE (j / 2, 0)) NE 0 THEN 
            ASSIGN vSString = "│".
         ELSE 
            IF vBFlag = YES THEN
               ASSIGN vSString = "┤".
            ELSE
               ASSIGN vSString = "│".
         ASSIGN vSString = vSString + "                │                │".
      END.
      PUT {&STREAM} UNFORMATTED vSString SKIP.
      ASSIGN vSString = "".
   END.
   	vSumCurrCC = vSumCurrCC + vSumCurrC.	
        vSumRubCC = vSumRubCC + vSumRubC.	

END.


PUT {&STREAM} UNFORMATTED
   "└──────┴──────────────────┴────────────────────┴─────────────────────────┴────────────────────┴──────────┴───────────┴────────────────────┴────────────────┴────────────────┴────────────────────┴──────────┴───────────┴────────────────────┴────────────────┴────────────────┴────────────────┴────────────────┘" SKIP(2)

/*   "ИТОГО клиентов: " vKolKl "   ИТОГО в валюте обязательств: "  STRING(vSumCurrD,"->>>,>>>,>>>,>>9.99") " ИТОГО в рублях обязательств: "  STRING(vSumRubD,"->>>,>>>,>>>,>>9.99") "   ИТОГО в валюте по требованиям: "  STRING(vSumCurrCC,"->>>,>>>,>>>,>>9.99") " ИТОГО в рублях по требованиям: "  STRING(vSumRubCC,"->>>,>>>,>>>,>>9.99")    "  ИТОГО обязательств: "  STRING(vSum17,"->>>,>>>,>>>,>>9.99")"  ИТОГО страхование: "  STRING(vSum18,"->>>,>>>,>>>,>>9.99") skip(2) */

   STRING (dept.mgr-title,"x(40)") " " STRING (dept.mgr-name,"x(50)") " Дата составления " STRING (vDate,"99/99/9999") SKIP (2)
   STRING (dept.cfo-title,"x(40)") " " STRING (dept.cfo-name,"x(50)") " Дата подписания  ____________"                 SKIP (2)
   "      М.П." SKIP (2)
   STRING ( "Исполнитель", "x(40)" ) " " LN_GetUserName (USERID ("bisquit"))  SKIP
   "Телефон " telefon (USERID ("bisquit")) SKIP ( 1 ).


/* {signatur.i &stream="{&STREAM}"} */

 &IF DEFINED(REEDPSA_SAV) &THEN
  {preview.i &stream="{&STREAM}" &filename=arch_file_name}
 &ELSE
  {preview2.i &stream="{&STREAM}"}
 &ENDIF



PROCEDURE Cutter.

DEF INPUT PARAM iStr AS INTEGER.
DEF INPUT PARAM iNum AS INTEGER.
DEF INPUT PARAM iFwd AS LOGICAL.

ASSIGN mI = 1.
REPEAT WHILE mI LE iNum:
   IF mS[mI] NE ? THEN
      IF iFwd EQ NO THEN
         ASSIGN 
            mS[mI] = mS[mI] + FILL (" ", (iStr - LENGTH(mS[mI]))).
      ELSE
         ASSIGN 
            mS[mI] = FILL (" ", (iStr - LENGTH(mS[mI]))) + mS[mI].
   ELSE
      ASSIGN 
         mS[mI] = FILL (" ", iStr).
   IF LENGTH(mS[mI]) GT iStr THEN 
      mS[mI] = SUBSTRING (mS[mI], 1, iStr).
   ASSIGN mI = mI + 1.  
END.

END PROCEDURE.
